<!DOCTYPE html>
<html class="no-js" lang="zxx" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge"/>
  <title>Checkout - ShopGrids Bootstrap 5 eCommerce HTML Template.</title>
  <meta name="description" content=""/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/images/favicon.svg">
  <script src="https://js.tosspayments.com/v1/payment"></script>

  <!-- ========================= CSS here ========================= -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/LineIcons.3.0.css">
  <link rel="stylesheet" href="/css/tiny-slider.css">
  <link rel="stylesheet" href="/css/glightbox.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <style>
    .error {
      border: 2px solid red;
    }
  </style>
</head>

<body>
<!-- Preloader -->
<div class="preloader">
  <div class="preloader-inner">
    <div class="preloader-icon">
      <span></span>
      <span></span>
    </div>
  </div>
</div>
<!-- /End Preloader -->

<!-- Start Header Area -->
<header th:replace="~{fragments/header :: header}"></header>

<!--====== Checkout Form Steps Part Start ======-->
<section class="checkout-wrapper section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="checkout-steps-form-style-1">
          <ul id="accordionExample">
            <li>
              <h6 class="title" data-bs-toggle="collapse" data-bs-target="#collapseThree"
                  aria-expanded="true" aria-controls="collapseThree">주문자 정보</h6>
              <section class="checkout-steps-form-content collapse show" id="collapseThree"
                       aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                <div class="row">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="single-form form-default">
                        <label>주문자명</label>
                        <div class="row">
                          <div class="col-md-6 form-input form">
                            <input type="text" name="orderName" id="orderName" placeholder="주문자명"
                                   th:value="${orderUserName}" required>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="single-form form-default">
                        <label>주문자 이메일</label>
                        <div class="form-input form">
                          <input type="text" name="orderEmail" id="orderEmail" placeholder="이메일"
                                 th:value="${orderUserEmail}" required>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="single-form form-default">
                        <label>주문자 핸드폰 번호</label>
                        <div class="form-input form">
                          <input type="text" id="orderPhoneNumber" name="orderPhoneNumber"
                                 placeholder="주문자 핸드폰 번호" th:value="${orderUserPhoneNumber}"
                                 required>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="single-form button">
                        <button class="btn" data-bs-toggle="collapse" data-bs-target="#collapseFour"
                                aria-expanded="false" aria-controls="collapseFour">다음 단계
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </li>
            <li>
              <h6 class="title collapsed" data-bs-toggle="collapse" data-bs-target="#collapseFour"
                  aria-expanded="false" aria-controls="collapseFour">배송정보</h6>
              <section class="checkout-steps-form-content collapse" id="collapseFour"
                       aria-labelledby="headingFour" data-bs-parent="#accordionExample">
                <div class="col-md-12">
                  <div class="single-checkbox checkbox-style-3">
                    <input type="checkbox" id="checkbox-3" onclick="copyOrderInfo()">
                    <label for="checkbox-3"><span></span></label>
                    <p>주문자 정보와 배송 정보가 동일합니다.</p>
                  </div>
                </div>
                <div class="col-md-12">
                  <button class="btn btn-secondary" onclick="openAddressPopup()"
                          th:disabled="${userInfo.role == 'NONE_MEMBER'}">배송지 목록 보기
                  </button>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>배송받는 사람</label>
                      <div class="row">
                        <div class="col-md-6 form-input form">
                          <input type="text" name="receiveName" id="receiveName"
                                 placeholder="배송받는 사람" required>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="single-form form-default">
                      <label>배송받는 사람 이메일</label>
                      <div class="form-input form">
                        <input type="text" name="receiveEmail" id="receiveEmail" placeholder="이메일"
                               required>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="single-form form-default">
                      <label>배송받는 사람 핸드폰 번호</label>
                      <div class="form-input form">
                        <input type="text" name="receivePhoneNumber" id="receivePhoneNumber"
                               placeholder="핸드폰 번호" required>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>주소</label>
                      <div class="form-input form">
                        <input type="text" id="postcode" placeholder="우편번호" required>
                        <input type="button" onclick="daumPost()" value="우편번호 찾기"><br>
                        <input type="text" id="addressRaw" placeholder="주소" required><br>
                        <input type="text" id="addressDetail" placeholder="상세주소" required>
                        <input type="text" id="reference" placeholder="참고항목">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>포장 타입</label>
                      <div class="form-input form">
                        <select id="takeoutType" name="takeoutType" onchange="updateTotalPrice()"
                                required>
                          <option value="" data-price="0">포장 타입을 선택하세요</option>
                          <option th:each="takeout : ${takeouts}" th:value="${takeout.takeoutType}"
                                  th:data-price="${takeout.takeoutPrice}"
                                  th:data-description="${takeout.takeoutDescription}"
                                  th:text="${takeout.takeoutDescription + ' - ' + takeout.takeoutPrice + '원'}"></option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>배송 받길 원하는 날짜</label>
                      <div class="form-input form">
                        <input type="date" id="deliveryDate" required>
                      </div>
                    </div>
                  </div>

                  <form id="orderForm" action="/orders" method="POST">
                    <input type="hidden" name="userId" id="userId" th:value="${userInfo.userId}">
                    <input type="hidden" name="role" id="role" th:value="${userInfo.role}">
                    <div th:each="cartBook, index : ${cartBooks}">
                      <input type="hidden" name="productIds" th:value="${cartBook.bookId}">
                      <input type="hidden" name="cartBookIds" th:value="${cartBook.cartBookId}">
                      <input type="hidden" name="quantities"
                             th:value="${cartBook.cartBookQuantity}">
                      <input type="hidden" name="prices" th:value="${cartBook.bookPrice}">
                    </div>
                    <input type="hidden" name="shippingFee" id="hiddenShippingFee">
                    <input type="hidden" name="points" id="hiddenPointsUsed" value="0">
                    <input type="hidden" name="takeoutPrice" id="hiddenTakeoutPrice">
                    <input type="hidden" name="orderId" id="hiddenOrderId">
                    <input type="hidden" name="discountPrice" id="hiddenDiscountPrice">
                    <input type="hidden" name="addressRaw" id="hiddenAddressRaw">
                    <input type="hidden" name="addressDetail" id="hiddenAddressDetail">
                    <input type="hidden" name="reference" id="hiddenReference">
                    <input type="hidden" name="zipcode" id="hiddenZipcode">
                    <input type="hidden" name="takeoutType" id="hiddenTakeoutType">
                    <input type="hidden" name="deliveryDate" id="hiddenDeliveryDate">
                    <input type="hidden" name="orderName" id="hiddenOrderName">
                    <input type="hidden" name="orderEmail" id="hiddenOrderEmail">
                    <input type="hidden" name="orderPhoneNumber" id="hiddenOrderPhoneNumber">
                    <input type="hidden" name="receiveName" id="hiddenReceiveOrderName">
                    <input type="hidden" name="receiveEmail" id="hiddenReceiveOrderEmail">
                    <input type="hidden" name="receivePhoneNumber"
                           id="hiddenReceiveOrderPhoneNumber">

                    <input type="hidden" name="orderTotalAmount" id="hiddenTotalPrice">

                    <div class="col-md-12">
                      <div class="checkout-payment-option">
                        <h6 class="heading-6 font-weight-400 payment-title">배송비 정책</h6>
                        <div class="payment-option-wrapper">
                          <div class="single-payment-option">
                            <input type="radio" name="shipping"
                                   th:id="'shipping-' + ${shippingPolicy.shippingPolicyId}"
                                   th:value="${shippingPolicy.shippingPolicyFee}" checked readonly>
                            <label th:for="'shipping-' + ${shippingPolicy.shippingPolicyId}">
                              <img src="https://via.placeholder.com/60x32" alt="Shipping">
                              <span class="price"
                                    th:text="${'배송비 ' + shippingPolicy.shippingPolicyFee + '원'}"></span>
                              <p class="min-amount"
                                 th:text="'최소 주문 금액 ' + ${shippingPolicy.shippingPolicyMinAmount} + '원'"></p>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>

                  </form>
                </div>
              </section>
            </li>
          </ul>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="checkout-sidebar">
          <button onclick="openCouponPopup()" th:disabled="${userInfo.role == 'NONE_MEMBER'}">쿠폰 목록
            보기
          </button>
          <input type="text" id="selectedCoupon" readonly
                 th:disabled="${userInfo.role == 'NONE_MEMBER'}">
          <input type="hidden" id="couponDiscount" value="0"
                 th:value="${maxDiscountCoupon != null ? maxDiscountCoupon.discountAmount : 0}">
          <input type="hidden" id="couponDiscountRate" value="0">
          <input type="hidden" id="couponId"
                 th:value="${maxDiscountCoupon != null ? maxDiscountCoupon.couponId : ''}">
          <div class="checkout-sidebar-price-table mt-30">
            <h5 class="title">Pricing Table</h5>
            <div class="sub-total-price">
              <div class="total-price">
                <p class="value">상품 금액:</p>
                <p class="price" th:text="${totalAmount + '원'}" id="totalAmount"></p>
              </div>
              <div class="total-price shipping">
                <p class="value">배송비:</p>
                <p class="price" id="shippingFee">0원</p>
              </div>
              <div class="total-price discount">
                <p class="value">할인:</p>
                <p class="price" id="discountAmount">0원</p>
              </div>
              <div class="total-price takeout">
                <p class="value">포장비:</p>
                <p class="price" id="takeoutPrice">0원</p>
              </div>
              <div class="col-md-12">
                <div class="single-form form-default">
                  <label>현재 포인트: <span id="currentPoints" th:text="${points}">0</span>pt</label>
                </div>
              </div>
              <div class="total-price points">
                <p class="value">포인트 사용:</p>
                <input type="number" id="points" value="0" min="0" th:max="${points}"
                       th:disabled="${userInfo.role == 'NONE_MEMBER'}" oninput="updateTotalPrice()">
                <p class="price" id="pointsDiscount">0원</p>
              </div>
              <div class="additional-info mt-30" th:if="${freeShippingAmount != null}">
                <p th:if="${freeShippingAmount > 0}"
                   th:text="'무료 배송까지 ' + ${freeShippingAmount} + '원'"></p>
                <p th:if="${freeShippingAmount <= 0}" th:text="'무료 배송 혜택 적용중!'"></p>
                <input type="hidden" id="freeShippingAmount" th:value="${freeShippingAmount}"/>
                <div class="progress">
                  <div class="progress-bar progress-bar-striped progress-bar-animated"
                       role="progressbar" id="progress-bar" th:aria-valuenow="0" aria-valuemin="0"
                       aria-valuemax="100" style="width: 0%"></div>
                </div>
              </div>
            </div>
            <div class="total-payable">
              <div class="payable-price">
                <p class="value">총 금액:</p>
                <p class="price" id="totalPriceValue">0원</p>
              </div>
            </div>
            <div class="price-table-btn button">
              <button type="button" class="btn btn-alt"
                      onclick="if (validateForm()) { submitOrder(); }">Checkout
              </button>
            </div>
          </div>

          <div class="checkout-sidebar-banner mt-30">
            <a href="#">
              <img src="https://via.placeholder.com/400x330" alt="#">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!--====== Checkout Form Steps Part Ends ======-->

<footer th:replace="~{fragments/footer :: footer}"></footer>

<!-- ========================= scroll-top ========================= -->
<a href="#" class="scroll-top">
  <i class="lni lni-chevron-up"></i>
</a>

<!-- ========================= JS here ========================= -->
<script src="/js/bootstrap.min.js"></script>
<script src="/js/tiny-slider.js"></script>
<script src="/js/glightbox.min.js"></script>
<script src="/js/main.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  function updateTotalPrice() {
    const totalAmountElement = document.getElementById('totalAmount');
    const totalAmount = parseInt(totalAmountElement.innerText.replace('원', '')) || 0;
    const shippingFee = parseInt(document.getElementById('shippingFee').innerText.replace('원', ''))
        || 0;
    const discountAmountElement = document.getElementById('couponDiscount');
    const discountRateElement = document.getElementById('couponDiscountRate');
    const discountAmount = parseInt(discountAmountElement.value) || 0;
    const discountRate = parseFloat(discountRateElement.value) || 0;
    const takeoutSelect = document.getElementById('takeoutType');
    const selectedOption = takeoutSelect.options[takeoutSelect.selectedIndex];
    const takeoutPrice = parseInt(selectedOption.getAttribute('data-price'), 10) || 0;
    let pointsDiscount = parseInt(document.getElementById('points').value, 10) || 0;

    let calculatedDiscount = discountAmount;
    if (discountAmount === 0 && discountRate > 0) {
      calculatedDiscount = totalAmount * (discountRate / 100);
    }

    const totalPriceBeforePoints = totalAmount - calculatedDiscount + shippingFee + takeoutPrice;

    if (pointsDiscount > totalPriceBeforePoints) {
      pointsDiscount = totalPriceBeforePoints;
      document.getElementById('points').value = totalPriceBeforePoints;
    }

    document.getElementById('takeoutPrice').textContent = takeoutPrice + '원';
    document.getElementById('pointsDiscount').textContent = pointsDiscount + '원';

    const totalPrice = totalPriceBeforePoints - pointsDiscount;

    document.getElementById('discountAmount').innerText = calculatedDiscount.toFixed(0) + '원';
    document.getElementById('totalPriceValue').innerText = totalPrice.toFixed(0) + '원';
  }

  function daumPost() {
    new daum.Postcode({
      oncomplete: function (data) {
        var addr = '';
        var extraAddr = '';

        if (data.userSelectedType === 'R') {
          addr = data.roadAddress;
        } else {
          addr = data.jibunAddress;
        }

        if (data.userSelectedType === 'R') {
          if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
            extraAddr += data.bname;
          }
          if (data.buildingName !== '' && data.apartment === 'Y') {
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          if (extraAddr !== '') {
            extraAddr = ' (' + extraAddr + ')';
          }
          document.getElementById("reference").value = extraAddr;

        } else {
          document.getElementById("addressExtra").value = '';
        }

        document.getElementById('postcode').value = data.zonecode;
        document.getElementById("addressRaw").value = addr;
        document.getElementById("addressDetail").focus();
      }
    }).open();
  }

  function copyOrderInfo() {
    const checkbox = document.getElementById('checkbox-3');
    if (checkbox.checked) {
      document.getElementById('receiveName').value = document.getElementById('orderName').value;
      document.getElementById('receiveEmail').value = document.getElementById('orderEmail').value;
      document.getElementById('receivePhoneNumber').value = document.getElementById(
          'orderPhoneNumber').value;
    } else {
      document.getElementById('receiveName').value = '';
      document.getElementById('receiveEmail').value = '';
      document.getElementById('receivePhoneNumber').value = '';
    }
  }

  function generateUUID() {
    return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  function submitOrder() {
    const orderId = `order-${generateUUID()}`;
    const deliveryDateValue = document.getElementById('deliveryDate').value;
    const totalPrice = document.getElementById('totalPriceValue').textContent;

    const getNumberValue = (id) => {
      const value = document.getElementById(id).textContent.replace('원', '').trim();
      return value ? value : "0";
    };

    const userId = document.getElementById('userId').value;
    const totalPriceValue = totalPrice.replace('원', '').trim();
    const takeoutPrice = document.getElementById('takeoutPrice').innerText.replace('원', '');
    const shippingFee = document.getElementById('shippingFee').innerText.replace('원', '');
    const couponDiscount = getNumberValue('discountAmount');
    const orderName = document.getElementById('orderName').value;
    const orderEmail = document.getElementById('orderEmail').value;
    const orderPhoneNumber = document.getElementById('orderPhoneNumber').value;
    const receiveName = document.getElementById('receiveName').value;
    const receiveEmail = document.getElementById('receiveEmail').value;
    const receivePhoneNumber = document.getElementById('receivePhoneNumber').value;
    const addressRaw = document.getElementById('addressRaw').value;
    const reference = document.getElementById('reference').value;
    const addressDetail = document.getElementById('addressDetail').value;
    const postcode = document.getElementById('postcode').value;
    const takeoutType = document.getElementById('takeoutType').value;
    const points = document.getElementById('points').value || "0";
    const role = document.getElementById('role').value;
    const productIds = Array.from(document.querySelectorAll('input[name="productIds"]')).map(
        input => input.value);
    const cartBookIds = Array.from(document.querySelectorAll('input[name="cartBookIds"]')).map(
        input => input.value);
    const quantities = Array.from(document.querySelectorAll('input[name="quantities"]')).map(
        input => input.value);
    const prices = Array.from(document.querySelectorAll('input[name="prices"]')).map(
        input => input.value);
    const couponId = document.getElementById('couponId').value;

    const orderData = {
      userId: userId,
      orderId: orderId,
      deliveryDate: deliveryDateValue,
      orderTotalAmount: totalPriceValue,
      takeoutPrice: takeoutPrice,
      shippingFee: shippingFee,
      discountPrice: couponDiscount,
      orderName: orderName,
      orderEmail: orderEmail,
      orderPhoneNumber: orderPhoneNumber,
      receiveName: receiveName,
      receiveEmail: receiveEmail,
      receivePhoneNumber: receivePhoneNumber,
      addressRaw: addressRaw,
      reference: reference,
      addressDetail: addressDetail,
      zipcode: postcode,
      takeoutType: takeoutType,
      points: points,
      productIds: productIds,
      quantities: quantities,
      prices: prices,
      cartBookIds: cartBookIds,
      role: role,
      couponId: couponId
    };

    fetch('/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(orderData),
    })
    .then(response => response.json())
    .then(data => {
      const {orderId, totalAmount} = data;
      if (parseInt(totalAmount, 10) === 0) {
        completeZeroAmountPayment(orderData);
      } else {
        startPaymentProcess(orderId, totalAmount);
      }
    })
    .catch(error => {
      console.error('주문 생성 및 결제 요청 중 오류 발생:', error);
      window.location.href = '/orders/fail'
    });
  }

  function completeZeroAmountPayment(orderData) {
    console.log("completeZeroAmountPayment 호출됨");
    const paymentKey = generateUUID();

    const paymentData = {
      paymentKey: paymentKey,
      orderId: orderData.orderId,
      amount: 0,
    };

    fetch('/payments/confirm/zero', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(paymentData),
    })
    .then(response => {
      if (response.ok) {
        const urlParams = new URLSearchParams({
          paymentKey: paymentKey,
          orderId: orderData.orderId,
          amount: "0",
        });
        window.location.href = `/payments/success?${urlParams.toString()}`;
      } else {
        console.log("결제 완료 처리 실패");
        window.location.href = '/payments/fail';
      }
    })
    .catch(error => {
      console.error('결제 완료 처리 중 오류 발생:', error);
      window.location.href = '/payments/fail';
    });
  }


  function startPaymentProcess(orderId, totalAmount) {
    const customerKey = generateUUID();

    const clientKey = 'test_ck_5OWRapdA8dJYOKZkAR06Vo1zEqZK';
    const tossPayments = TossPayments(clientKey);

    tossPayments.requestPayment('카드', {
      amount: totalAmount,
      orderId: orderId,
      orderName: orderId,
      customerName: customerKey,
      successUrl: window.location.origin + "/payments/success",
      failUrl: window.location.origin + "/payments/fail",
    })
    .catch(function (error) {
      if (error.code === 'USER_CANCEL') {
        console.error('사용자가 결제를 취소하였습니다.');
      } else if (error.code === 'INVALID_CARD_COMPANY') {
        console.error('유효하지 않은 카드 회사입니다.');
      }
    });
  }

  function openCouponPopup() {
    const popup = window.open(`/orders/coupons`, '쿠폰 목록', 'width=600,height=400');
    popup.onunload = function () {
      if (popup.selectedCoupon) {
        document.getElementById('selectedCoupon').value = popup.selectedCoupon;
        document.getElementById('couponDiscount').value = popup.selectedCouponDiscount;
        document.getElementById('couponId').value = popup.selectedCouponId;
        updateTotalPrice();
      }
    }
  }

  function openAddressPopup() {
    const popup = window.open(`/orders/address`, '배송지 목록', 'width=600,height=400');
    popup.onunload = function () {
      if (popup.selectedAddress) {
        document.getElementById('postcode').value = popup.selectedAddress.postcode;
        document.getElementById('addressRaw').value = popup.selectedAddress.rawAddress;
        document.getElementById('addressDetail').value = popup.selectedAddress.detailAddress;
        document.getElementById('reference').value = popup.selectedAddress.reference;
      }
    }
  }

  function updateAddressFields(address) {
    document.getElementById('postcode').value = address.postcode;
    document.getElementById('addressRaw').value = address.rawAddress;
    document.getElementById('addressDetail').value = address.detailAddress;
    document.getElementById('reference').value = address.reference;
  }

  function updateShippingFee(fee) {
    document.getElementById('shippingFee').innerText = fee + '원';
    updateTotalPrice();
  }

  document.addEventListener('DOMContentLoaded', function () {
    const firstShippingOption = document.querySelector('input[name="shipping"]:checked');
    if (firstShippingOption) {
      updateShippingFee(firstShippingOption.value);
    } else {
      updateTotalPrice();
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    const totalAmountElement = document.getElementById('totalAmount');
    const freeShippingAmountElement = document.getElementById('freeShippingAmount');

    if (!totalAmountElement || !freeShippingAmountElement) {
      console.error('필요한 요소가 존재하지 않습니다.');
      return;
    }

    const totalAmountText = totalAmountElement.innerText.replace('원', '');
    const totalAmount = parseInt(totalAmountText, 10);
    const freeShippingAmount = parseInt(freeShippingAmountElement.value, 10);
    const progressBar = document.getElementById("progress-bar");

    let progress = 0;
    if (freeShippingAmount <= 0) {
      progress = 100;
    } else {
      progress = Math.min((totalAmount / (totalAmount + freeShippingAmount)) * 100, 100);
    }

    animateProgressBar(progressBar, progress);
  });

  function animateProgressBar(progressBar, targetProgress) {
    let currentProgress = 0;
    const animationDuration = 1000;
    const frameRate = 30;

    const increment = (targetProgress - currentProgress) / (animationDuration / (1000 / frameRate));

    const intervalId = setInterval(function () {
      currentProgress += increment;
      if (currentProgress >= targetProgress) {
        currentProgress = targetProgress;
        clearInterval(intervalId);
      }

      progressBar.style.width = currentProgress + "%";
      progressBar.setAttribute('aria-valuenow', currentProgress.toFixed(0));
      progressBar.innerText = currentProgress.toFixed(0) + "%";
    }, 1000 / frameRate);
  }

  function validateForm() {
    const requiredFields = [
      'orderName',
      'orderEmail',
      'orderPhoneNumber',
      'receiveName',
      'receiveEmail',
      'receivePhoneNumber',
      'postcode',
      'addressRaw',
      'addressDetail',
      'takeoutType',
      'deliveryDate'
    ];

    let isValid = true;

    for (const fieldId of requiredFields) {
      const field = document.getElementById(fieldId);
      if (!field || !field.value.trim()) {
        field.classList.add('error');
        if (isValid) {
          field.focus();
        }
        isValid = false;
      } else {
        field.classList.remove('error');
      }
    }

    return isValid;
  }

  window.addEventListener('load', function () {
    setTimeout(function () {
      const preloader = document.querySelector('.preloader');
      if (preloader) {
        preloader.classList.add('hidden');
      }
    }, 1000);
  });
</script>
</body>

</html>
