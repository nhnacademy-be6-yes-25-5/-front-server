<!DOCTYPE html>
<html class="no-js" lang="zxx" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge"/>
  <title>Checkout - ShopGrids Bootstrap 5 eCommerce HTML Template.</title>
  <meta name="description" content=""/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/images/favicon.svg">
  <script src="https://js.tosspayments.com/v1/payment"></script>

  <!-- ========================= CSS here ========================= -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/LineIcons.3.0.css">
  <link rel="stylesheet" href="/css/tiny-slider.css">
  <link rel="stylesheet" href="/css/glightbox.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <style>
    .payment-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .payment-option {
      display: flex;
      align-items: center;
    }

    .payment-option input[type="radio"] {
      display: none;
    }

    .payment-option .switch {
      display: flex;
      align-items: center;
      position: relative;
      cursor: pointer;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 25px;
      transition: background-color 0.3s;
    }

    .payment-option .switch .switch-inner {
      width: 40px;
      height: 20px;
      background-color: #ccc;
      border-radius: 15px;
      transition: background-color 0.3s;
    }

    .payment-option .switch .switch-handle {
      width: 20px;
      height: 20px;
      background-color: #fff;
      border-radius: 50%;
      position: absolute;
      left: 0;
      transition: left 0.3s;
    }

    .payment-option input[type="radio"]:checked + .switch .switch-inner {
      background-color: #4caf50;
    }

    .payment-option input[type="radio"]:checked.toss + .switch .switch-inner {
      background-color: #001da8 !important;
    }

    .payment-option input[type="radio"]:checked.kakao + .switch .switch-inner {
      background-color: #ffe900 !important;
    }

    .payment-option input[type="radio"]:checked.naver + .switch .switch-inner {
      background-color: #05c25b !important;
    }

    .payment-option input[type="radio"]:checked + .switch .switch-handle {
      left: 30px;
    }

    .payment-option .switch i {
      margin-left: 10px;
    }
  </style>
</head>

<body>
<!-- Preloader -->
<div class="preloader">
  <div class="preloader-inner">
    <div class="preloader-icon">
      <span></span>
      <span></span>
    </div>
  </div>
</div>
<!-- /End Preloader -->

<!-- Start Header Area -->
<header th:replace="~{fragments/header :: header}"></header>

<!--====== Checkout Form Steps Part Start ======-->
<section class="checkout-wrapper section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="checkout-steps-form-style-1">
          <ul id="accordionExample">
            <li>
              <h6 class="title" data-bs-toggle="collapse" data-bs-target="#collapseThree"
                  aria-expanded="true" aria-controls="collapseThree">주문자 정보</h6>
              <section class="checkout-steps-form-content collapse show" id="collapseThree"
                       aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                <div class="row">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="single-form form-default">
                        <label>주문자명</label>
                        <div class="row">
                          <div class="col-md-6 form-input form">
                            <input type="text" name="orderName" id="orderName" placeholder="주문자명"
                                   th:value="${orderUserName}" required>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="single-form form-default">
                        <label>주문자 이메일</label>
                        <div class="form-input form">
                          <input type="text" name="orderEmail" id="orderEmail" placeholder="이메일"
                                 th:value="${orderUserEmail}" required>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="single-form form-default">
                        <label>주문자 핸드폰 번호</label>
                        <div class="form-input form">
                          <input type="text" id="orderPhoneNumber" name="orderPhoneNumber"
                                 placeholder="주문자 핸드폰 번호" th:value="${orderUserPhoneNumber}"
                                 required>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="single-form button">
                        <button class="btn" data-bs-toggle="collapse" data-bs-target="#collapseFour"
                                aria-expanded="false" aria-controls="collapseFour">다음 단계
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </li>
            <li>
              <h6 class="title collapsed" data-bs-toggle="collapse" data-bs-target="#collapseFour"
                  aria-expanded="false" aria-controls="collapseFour">배송정보</h6>
              <section class="checkout-steps-form-content collapse" id="collapseFour"
                       aria-labelledby="headingFour" data-bs-parent="#accordionExample">
                <div class="col-md-12">
                  <div class="single-checkbox checkbox-style-3" style="margin: 20px 0 10px 0;">
                    <input type="checkbox" id="checkbox-3" onclick="copyOrderInfo()">
                    <label for="checkbox-3"><span></span></label>
                    <p>주문자 정보와 배송 정보가 동일합니다.</p>
                  </div>
                </div>
                <div class="col-md-12 address-button">
                  <button class="btn btn-secondary" onclick="openAddressPopup()"
                          th:disabled="${userInfo.role == 'NONE_MEMBER'}">배송지 목록 보기
                  </button>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>배송받는 사람</label>
                      <div class="row">
                        <div class="col-md-6 form-input form">
                          <input type="text" name="receiveName" id="receiveName"
                                 placeholder="배송받는 사람" required>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="single-form form-default">
                      <label>배송받는 사람 이메일</label>
                      <div class="form-input form">
                        <input type="text" name="receiveEmail" id="receiveEmail" placeholder="이메일"
                               required>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="single-form form-default">
                      <label>배송받는 사람 핸드폰 번호</label>
                      <div class="form-input form">
                        <input type="text" name="receivePhoneNumber" id="receivePhoneNumber"
                               placeholder="핸드폰 번호" required>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="single-form form-default address-form">
                      <label>주소</label>
                      <div class="form-input form">
                        <input type="text" id="postcode" placeholder="우편번호" required>
                        <input type="button" onclick="daumPost()" value="우편번호 찾기"><br>
                        <input type="text" id="addressRaw" placeholder="주소" required><br>
                        <input type="text" id="addressDetail" placeholder="상세주소" required>
                        <input type="text" id="reference" placeholder="참고항목">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>
                        포장 타입</label>
                      <div class="form-input form">
                        <div class="takeout-options" style="display: flex; justify-content: space-between;">
                          <div class="takeout-option single-payment-option" th:each="takeout : ${takeouts}" style="width: 32%; padding: 10px 0 !important;">
                            <input type="radio" th:id="'takeout-' + ${takeout.takeoutType}" name="takeoutType"
                                   th:value="${takeout.takeoutType}" th:data-price="${takeout.takeoutPrice}"
                                   th:data-description="${takeout.takeoutDescription}" th:onchange="updateTotalPrice()" required>
                            <label th:for="'takeout-' + ${takeout.takeoutType}">
                              <div class="takeout-description" th:text="${takeout.takeoutDescription}"></div>
                              <div class="takeout-price" th:text="${takeout.takeoutPrice + '원'}"></div>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>배송예정일</label>
                      <div class="form-input form">
                        <input type="date" id="deliveryDate" required>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-12">
                    <div class="checkout-payment-option">
                      <h6 class="heading-6 font-weight-400 payment-title">적용 예정 배송비 정책</h6>
                      <div class="payment-option-wrapper">
                        <div class="single-payment-option">
                          <input type="radio" name="shipping"
                                 th:id="'shipping-' + ${shippingPolicy.shippingPolicyId}"
                                 th:value="${shippingPolicy.shippingPolicyFee}" checked readonly>
                          <label th:for="'shipping-' + ${shippingPolicy.shippingPolicyId}">
                            <span class="price"
                                  th:text="${'배송비 ' + shippingPolicy.shippingPolicyFee + '원'}"></span>
                            <p class="min-amount"
                               th:text="'최소 주문 금액 ' + ${shippingPolicy.shippingPolicyMinAmount} + '원'"></p>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-12">
                      <div class="single-form button">
                        <button class="btn" data-bs-toggle="collapse" data-bs-target="#collapseFive"
                                aria-expanded="false" aria-controls="collapseFive">다음 단계
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </li>

            <!-- 결제 정보 섹션 추가 -->
            <li>
              <h6 class="title collapsed" data-bs-toggle="collapse" data-bs-target="#collapseFive"
                  aria-expanded="false" aria-controls="collapseFive">결제 정보</h6>
              <section class="checkout-steps-form-content collapse" id="collapseFive"
                       aria-labelledby="headingFive" data-bs-parent="#accordionExample">
                <div class="row">
                  <div class="col-md-12">
                    <div class="single-form form-default">
                      <label>결제 수단 선택</label>
                      <div class="form-input form">
                        <div class="payment-options">
                          <div class="payment-option">
                            <input type="radio" id="toss" name="paymentMethod" value="toss" required class="toss">
                            <label for="toss" class="switch">
                              <span class="switch-inner"></span>
                              <span class="switch-handle"></span>
                              <i class="lni lni-credit-cards"></i> 토스
                            </label>
                          </div>
                          <div class="payment-option">
                            <input type="radio" id="general" name="paymentMethod" value="general" required>
                            <label for="general" class="switch">
                              <span class="switch-inner"></span>
                              <span class="switch-handle"></span>
                              <i class="lni lni-visa"></i> 일반결제
                            </label>
                          </div>
                          <div class="payment-option">
                            <input type="radio" id="kakao" name="paymentMethod" value="kakao" required class="kakao">
                            <label for="kakao" class="switch">
                              <span class="switch-inner"></span>
                              <span class="switch-handle"></span>
                              <i class="lni lni-kakao-talk"></i> 카카오페이
                            </label>
                          </div>
                          <div class="payment-option">
                            <input type="radio" id="naver" name="paymentMethod" value="naver" required class="naver">
                            <label for="naver" class="switch">
                              <span class="switch-inner"></span>
                              <span class="switch-handle"></span>
                              <i class="lni lni-naver"></i> 네이버페이
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="cardInfoFields" style="display: none;">
                  <div class="col-12">
                    <div class="checkout-payment-form">
                      <div class="single-form form-default">
                        <label>카드 소유자 이름</label>
                        <div class="form-input form">
                          <input type="text" id="cardHolderName" placeholder="Cardholder Name">
                        </div>
                      </div>
                      <div class="single-form form-default">
                        <label>카드 번호</label>
                        <div class="form-input form">
                          <input id="cardNumber" type="text" placeholder="0000 0000 0000 0000">
                        </div>
                      </div>
                      <div class="payment-card-info">
                        <div class="single-form form-default mm-yy">
                          <label>유효기간</label>
                          <div class="expiration d-flex">
                            <div class="form-input form">
                              <input type="text" id="cardExpiryMM" placeholder="MM">
                            </div>
                            <div class="form-input form">
                              <input type="text" id="cardExpiryYY" placeholder="YYYY">
                            </div>
                          </div>
                        </div>
                        <div class="single-form form-default">
                          <label>CVC/CVV <span><i class="mdi mdi-alert-circle"></i></span></label>
                          <div class="form-input form">
                            <input type="text" id="cardCVC" placeholder="***">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </li>
          </ul>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="checkout-sidebar">
          <button class="btn btn-primary" onclick="openCouponPopup()" th:disabled="${userInfo.role == 'NONE_MEMBER'}">쿠폰 목록 보기</button>
          <input type="text" id="selectedCoupon" readonly
                 th:disabled="${userInfo.role == 'NONE_MEMBER'}"
                 th:value="${maxDiscountCoupon != null ? maxDiscountCoupon.couponName : ''}"
                 style="height: 37px;
                        border: 1px solid #DDD;
                        padding: 1px 0 4px 0;
                        width: 285px;
                        margin: 0 0 0 12px;">
          <input type="hidden" id="couponDiscount" value="0"
                 th:value="${maxDiscountCoupon != null ? maxDiscountCoupon.discountAmount : 0}">
          <input type="hidden" id="couponDiscountRate" value="0">
          <input type="hidden" id="couponId"
                 th:value="${maxDiscountCoupon != null and maxDiscountCoupon.couponId != null ? maxDiscountCoupon.couponId : ''}">
          <input type="hidden" name="userId" id="userId" th:value="${userInfo.userId}">
          <input type="hidden" name="role" id="role" th:value="${userInfo.role}">
          <div th:each="cartBook, index : ${cartBooks}">
            <input type="hidden" name="productIds" th:value="${cartBook.bookId}">
            <input type="hidden" name="quantities"
                   th:value="${cartBook.cartBookQuantity}">
            <input type="hidden" name="prices" th:value="${cartBook.bookPrice}">
          </div>
          <input type="hidden" name="shippingFee" id="hiddenShippingFee">
          <input type="hidden" name="points" id="hiddenPointsUsed" value="0">
          <input type="hidden" name="takeoutPrice" id="hiddenTakeoutPrice">
          <input type="hidden" name="orderId" id="orderId" th:value="${orderId}">
          <input type="hidden" name="cartId" id="cartId" th:value="${cartId}">
          <input type="hidden" name="discountPrice" id="hiddenDiscountPrice">
          <input type="hidden" name="addressRaw" id="hiddenAddressRaw">
          <input type="hidden" name="addressDetail" id="hiddenAddressDetail">
          <input type="hidden" name="reference" id="hiddenReference">
          <input type="hidden" name="zipcode" id="hiddenZipcode">
          <input type="hidden" name="takeoutType" id="hiddenTakeoutType">
          <input type="hidden" name="deliveryDate" id="hiddenDeliveryDate">
          <input type="hidden" name="orderName" id="hiddenOrderName">
          <input type="hidden" name="orderEmail" id="hiddenOrderEmail">
          <input type="hidden" name="orderPhoneNumber" id="hiddenOrderPhoneNumber">
          <input type="hidden" name="receiveName" id="hiddenReceiveOrderName">
          <input type="hidden" name="receiveEmail" id="hiddenReceiveOrderEmail">
          <input type="hidden" name="receivePhoneNumber"
                 id="hiddenReceiveOrderPhoneNumber">

          <input type="hidden" name="orderTotalAmount" id="hiddenTotalPrice">
          <div class="checkout-sidebar-price-table mt-30">
            <h5 class="title">Pricing Table</h5>
            <div class="sub-total-price">
              <div class="total-price">
                <p class="value">상품 금액:</p>
                <p class="price" th:text="${totalAmount + '원'}" id="totalAmount"></p>
              </div>
              <div class="total-price shipping">
                <p class="value">배송비:</p>
                <p class="price" id="shippingFee">0원</p>
              </div>
              <div class="total-price discount">
                <p class="value">할인:</p>
                <p class="price" id="discountAmount">0원</p>
              </div>
              <div class="total-price takeout">
                <p class="value">포장비:</p>
                <p class="price" id="takeoutPrice">0원</p>
              </div>
              <div class="col-md-12">
                <div class="single-form form-default">
                  <label>현재 포인트: <span id="currentPoints" th:text="${points}">0</span>pt</label>
                </div>
              </div>
              <div class="total-price points">
                <p class="value">포인트 사용:</p>
                <input type="number" id="points" value="0" min="0" th:max="${points}"
                       th:disabled="${userInfo.role == 'NONE_MEMBER'}" oninput="validatePointsUsage()">
              </div>
              <p class="price" id="pointsDiscount" style="display: block">0원</p>
              <div class="additional-info mt-30" th:if="${freeShippingAmount != null}">
                <p th:if="${freeShippingAmount > 0}"
                   th:text="'무료 배송까지 ' + ${freeShippingAmount} + '원'"></p>
                <p th:if="${freeShippingAmount <= 0}" th:text="'무료 배송 혜택 적용중!'"></p>
                <input type="hidden" id="freeShippingAmount" th:value="${freeShippingAmount}"/>
                <div class="progress">
                  <div class="progress-bar progress-bar-striped progress-bar-animated"
                       role="progressbar" id="progress-bar" th:aria-valuenow="0" aria-valuemin="0"
                       aria-valuemax="100" style="width: 0%"></div>
                </div>
              </div>
            </div>
            <div class="total-payable">
              <div class="payable-price">
                <p class="value">총 금액:</p>
                <p class="price" id="totalPriceValue">0원</p>
              </div>
            </div>
            <div class="price-table-btn button">
              <button type="button" class="btn btn-alt"
                      onclick="if (validateForm()) { submitOrder(); }">Checkout
              </button>
            </div>
          </div>

          <div class="checkout-sidebar-banner mt-30">
            <a href="#">
              <img src="https://via.placeholder.com/400x330" alt="#">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!--====== Checkout Form Steps Part Ends ======-->

<footer th:replace="~{fragments/footer :: footer}"></footer>

<!-- ========================= scroll-top ========================= -->
<a href="#" class="scroll-top">
  <i class="lni lni-chevron-up"></i>
</a>

<!-- ========================= JS here ========================= -->
<script src="/js/bootstrap.min.js"></script>
<script src="/js/tiny-slider.js"></script>
<script src="/js/glightbox.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/paymentFactory.js"></script>
<script src="/js/PaymentService.js"></script>
<script src="/js/TossPaymentService.js"></script>
<script src="/js/NaverPaymentService.js"></script>
<script src="/js/KakaoPaymentService.js"></script>
<script src="/js/GeneralPaymentService.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  function setMinDeliveryDate() {
    const deliveryDateInput = document.getElementById('deliveryDate');
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const minDeliveryDate = new Date(today);
    minDeliveryDate.setDate(today.getDate() + 3);

    const minDateString = minDeliveryDate.toISOString().split('T')[0];
    deliveryDateInput.setAttribute('min', minDateString);
  }

  document.addEventListener('DOMContentLoaded', function () {
    setMinDeliveryDate();
    const firstShippingOption = document.querySelector('input[name="shipping"]:checked');
    if (firstShippingOption) {
      updateShippingFee(firstShippingOption.value);
    } else {
      updateTotalPrice();
    }
  });

  function updateTotalPrice() {
    const totalAmountElement = document.getElementById('totalAmount');
    const totalAmount = parseInt(totalAmountElement.innerText.replace('원', '')) || 0;
    const shippingFee = parseInt(document.getElementById('shippingFee').innerText.replace('원', '')) || 0;
    const discountAmountElement = document.getElementById('couponDiscount');
    const discountRateElement = document.getElementById('couponDiscountRate');
    const discountAmount = parseInt(discountAmountElement.value) || 0;
    const discountRate = parseFloat(discountRateElement.value) || 0;
    const takeoutSelect = document.querySelector('input[name="takeoutType"]:checked');

    let takeoutPrice = 0;
    if (takeoutSelect) {
      takeoutPrice = parseInt(takeoutSelect.getAttribute('data-price'), 10) || 0;
    }

    let pointsDiscount = parseInt(document.getElementById('points').value, 10) || 0;

    let calculatedDiscount = discountAmount;
    if (discountAmount === 0 && discountRate > 0) {
      calculatedDiscount = totalAmount * (discountRate / 100);
    }

    const totalPriceBeforePoints = totalAmount - calculatedDiscount + shippingFee + takeoutPrice;

    if (pointsDiscount > totalPriceBeforePoints) {
      pointsDiscount = totalPriceBeforePoints;
      document.getElementById('points').value = totalPriceBeforePoints;
    }

    document.getElementById('takeoutPrice').textContent = takeoutPrice + '원';
    document.getElementById('pointsDiscount').textContent = pointsDiscount + '원';

    const totalPrice = totalPriceBeforePoints - pointsDiscount;

    document.getElementById('discountAmount').innerText = calculatedDiscount.toFixed(0) + '원';
    document.getElementById('totalPriceValue').innerText = totalPrice.toFixed(0) + '원';
  }

  function daumPost() {
    new daum.Postcode({
      oncomplete: function (data) {
        var addr = '';
        var extraAddr = '';

        if (data.userSelectedType === 'R') {
          addr = data.roadAddress;
        } else {
          addr = data.jibunAddress;
        }

        if (data.userSelectedType === 'R') {
          if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
            extraAddr += data.bname;
          }
          if (data.buildingName !== '' && data.apartment === 'Y') {
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          if (extraAddr !== '') {
            extraAddr = ' (' + extraAddr + ')';
          }
          document.getElementById("reference").value = extraAddr;

        } else {
          document.getElementById("addressExtra").value = '';
        }

        document.getElementById('postcode').value = data.zonecode;
        document.getElementById("addressRaw").value = addr;
        document.getElementById("addressDetail").focus();
      }
    }).open();
  }

  function copyOrderInfo() {
    const checkbox = document.getElementById('checkbox-3');
    if (checkbox.checked) {
      document.getElementById('receiveName').value = document.getElementById('orderName').value;
      document.getElementById('receiveEmail').value = document.getElementById('orderEmail').value;
      document.getElementById('receivePhoneNumber').value = document.getElementById(
          'orderPhoneNumber').value;
    } else {
      document.getElementById('receiveName').value = '';
      document.getElementById('receiveEmail').value = '';
      document.getElementById('receivePhoneNumber').value = '';
    }
  }

  function generateUUID() {
    return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  function submitOrder() {
    const ALLOWED_PAYMENT_METHODS = ['toss'];

    const paymentMethodElement = document.querySelector('input[name="paymentMethod"]:checked');
    if (!paymentMethodElement) {
      alert('결제 수단을 선택해주세요.');
      return;
    }
    const paymentMethod = paymentMethodElement.value;

    console.log(paymentMethod);
    if (!ALLOWED_PAYMENT_METHODS.includes(paymentMethod)) {
      alert('현재 개발중인 결제 수단입니다. 다른 결제수단을 사용해주세요.');
      return;
    }

    const deliveryDateElement = document.getElementById('deliveryDate');
    const totalPriceElement = document.getElementById('totalPriceValue');
    const takeoutPriceElement = document.getElementById('takeoutPrice');
    const shippingFeeElement = document.getElementById('shippingFee');
    const orderIdElement = document.getElementById('orderId');
    const cartIdElement = document.getElementById('cartId');
    const orderNameElement = document.getElementById('orderName');
    const orderEmailElement = document.getElementById('orderEmail');
    const orderPhoneNumberElement = document.getElementById('orderPhoneNumber');
    const receiveNameElement = document.getElementById('receiveName');
    const receiveEmailElement = document.getElementById('receiveEmail');
    const receivePhoneNumberElement = document.getElementById('receivePhoneNumber');
    const addressRawElement = document.getElementById('addressRaw');
    const referenceElement = document.getElementById('reference');
    const addressDetailElement = document.getElementById('addressDetail');
    const postcodeElement = document.getElementById('postcode');
    const pointsElement = document.getElementById('points');
    const roleElement = document.getElementById('role');
    const couponIdElement = document.getElementById('couponId');

    const requiredElements = [
      deliveryDateElement, totalPriceElement, takeoutPriceElement, shippingFeeElement,
      orderIdElement, cartIdElement, orderNameElement, orderEmailElement, orderPhoneNumberElement,
      receiveNameElement, receiveEmailElement, receivePhoneNumberElement, addressRawElement,
      referenceElement, addressDetailElement, postcodeElement, pointsElement, roleElement, couponIdElement
    ];

    for (const element of requiredElements) {
      if (!element) {
        console.error(`Element with ID ${element.id} not found.`);
        return;
      }
    }

    const getNumberValue = (id) => {
      const value = document.getElementById(id).textContent.replace('원', '').trim();
      return value ? value : "0";
    };

    const deliveryDateValue = deliveryDateElement.value;
    const totalPriceValue = totalPriceElement.textContent.replace('원', '').trim();
    const takeoutPrice = takeoutPriceElement.innerText.replace('원', '');
    const shippingFee = shippingFeeElement.innerText.replace('원', '');
    const couponDiscount = getNumberValue('discountAmount');
    const orderId = orderIdElement.value;
    const cartId = cartIdElement.value;
    const orderName = orderNameElement.value;
    const orderEmail = orderEmailElement.value;
    const orderPhoneNumber = orderPhoneNumberElement.value;
    const receiveName = receiveNameElement.value;
    const receiveEmail = receiveEmailElement.value;
    const receivePhoneNumber = receivePhoneNumberElement.value;
    const addressRaw = addressRawElement.value;
    const reference = referenceElement.value;
    const addressDetail = addressDetailElement.value;
    const postcode = postcodeElement.value;
    const takeoutTypeElement = document.querySelector('input[name="takeoutType"]:checked');
    const takeoutType = takeoutTypeElement ? takeoutTypeElement.value : "";
    const points = pointsElement.value || "0";
    const role = roleElement.value;
    const productIds = Array.from(document.querySelectorAll('input[name="productIds"]')).map(
        input => input.value);
    const quantities = Array.from(document.querySelectorAll('input[name="quantities"]')).map(
        input => input.value);
    const prices = Array.from(document.querySelectorAll('input[name="prices"]')).map(
        input => input.value);
    const couponId = couponIdElement.value;

    const orderData = {
      orderId: orderId,
      deliveryDate: deliveryDateValue,
      orderTotalAmount: totalPriceValue,
      takeoutPrice: takeoutPrice,
      shippingFee: shippingFee,
      discountPrice: couponDiscount,
      orderName: orderName,
      orderEmail: orderEmail,
      orderPhoneNumber: orderPhoneNumber,
      receiveName: receiveName,
      receiveEmail: receiveEmail,
      receivePhoneNumber: receivePhoneNumber,
      addressRaw: addressRaw,
      reference: reference,
      addressDetail: addressDetail,
      zipcode: postcode,
      takeoutType: takeoutType,
      points: points,
      productIds: productIds,
      quantities: quantities,
      prices: prices,
      role: role,
      couponId: couponId,
      cartId: cartId
    };

    fetch('/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(orderData),
    })
    .then(response => response.json())
    .then(data => {
      const {orderId, totalAmount} = data;
      const paymentService = createPaymentService(paymentMethod);
      if (parseInt(totalAmount, 10) === 0) {
        completeZeroAmountPayment(orderData);
      } else {
        paymentService.requestPayment({orderId, totalAmount})
        .catch(error => {
          console.error('결제 요청 중 오류 발생:', error);
          window.location.href = '/payments/fail';
        });
      }
    })
    .catch(error => {
      console.error('주문 생성 중 오류 발생:', error);
      window.location.href = '/orders/fail';
    });
  }

  function completeZeroAmountPayment(orderData) {
    console.log("completeZeroAmountPayment 호출됨");
    const paymentKey = generateUUID();

    const paymentData = {
      paymentKey: paymentKey,
      orderId: orderData.orderId,
      amount: 0,
    };

    fetch('/payments/confirm/zero', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(paymentData),
    })
    .then(response => {
      if (response.ok) {
        const urlParams = new URLSearchParams({
          paymentKey: paymentKey,
          orderId: orderData.orderId,
          amount: "0",
        });
        window.location.href = `/payments/success?${urlParams.toString()}`;
      } else {
        console.log("결제 완료 처리 실패");
        window.location.href = '/payments/fail';
      }
    })
    .catch(error => {
      console.error('결제 완료 처리 중 오류 발생:', error);
      window.location.href = '/payments/fail';
    });
  }

  function openCouponPopup() {
    const popup = window.open('/orders/coupons', '쿠폰 목록', 'width=600,height=400');
    popup.onunload = function() {
      if (popup.selectedCoupon) {
        document.getElementById('selectedCoupon').value = popup.selectedCoupon;
        document.getElementById('couponDiscount').value = popup.selectedCouponDiscount;
        document.getElementById('couponId').value = popup.selectedCouponId;
        updateTotalPrice();
      }
    }
  }

  function openAddressPopup() {
    const popup = window.open('/orders/address', '배송지 목록', 'width=600,height=400');
    popup.onunload = function() {
      if (popup.selectedAddress) {
        document.getElementById('postcode').value = popup.selectedAddress.postcode;
        document.getElementById('addressRaw').value = popup.selectedAddress.rawAddress;
        document.getElementById('addressDetail').value = popup.selectedAddress.detailAddress;
        document.getElementById('reference').value = popup.selectedAddress.reference;
      }
    }
  }


  function updateAddressFields(address) {
    document.getElementById('postcode').value = address.postcode;
    document.getElementById('addressRaw').value = address.rawAddress;
    document.getElementById('addressDetail').value = address.detailAddress;
    document.getElementById('reference').value = address.reference;
  }

  function updateShippingFee(fee) {
    document.getElementById('shippingFee').innerText = fee + '원';
    updateTotalPrice();
  }

  document.addEventListener('DOMContentLoaded', function () {
    const firstShippingOption = document.querySelector('input[name="shipping"]:checked');
    if (firstShippingOption) {
      updateShippingFee(firstShippingOption.value);
    } else {
      updateTotalPrice();
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    const totalAmountElement = document.getElementById('totalAmount');
    const freeShippingAmountElement = document.getElementById('freeShippingAmount');

    if (!totalAmountElement || !freeShippingAmountElement) {
      console.error('필요한 요소가 존재하지 않습니다.');
      return;
    }

    const totalAmountText = totalAmountElement.innerText.replace('원', '');
    const totalAmount = parseInt(totalAmountText, 10);
    const freeShippingAmount = parseInt(freeShippingAmountElement.value, 10);
    const progressBar = document.getElementById("progress-bar");

    let progress = 0;
    if (freeShippingAmount <= 0) {
      progress = 100;
    } else {
      progress = Math.min((totalAmount / (totalAmount + freeShippingAmount)) * 100, 100);
    }

    animateProgressBar(progressBar, progress);
  });

  function animateProgressBar(progressBar, targetProgress) {
    let currentProgress = 0;
    const animationDuration = 1000;
    const frameRate = 30;

    const increment = (targetProgress - currentProgress) / (animationDuration / (1000 / frameRate));

    const intervalId = setInterval(function () {
      currentProgress += increment;
      if (currentProgress >= targetProgress) {
        currentProgress = targetProgress;
        clearInterval(intervalId);
      }

      progressBar.style.width = currentProgress + "%";
      progressBar.setAttribute('aria-valuenow', currentProgress.toFixed(0));
      progressBar.innerText = currentProgress.toFixed(0) + "%";
    }, 1000 / frameRate);
  }

  function validateForm() {
    const requiredFields = [
      'orderName',
      'orderEmail',
      'orderPhoneNumber',
      'receiveName',
      'receiveEmail',
      'receivePhoneNumber',
      'postcode',
      'addressRaw',
      'addressDetail',
      'deliveryDate'
    ];

    let isValid = true;

    for (const fieldId of requiredFields) {
      const field = document.getElementById(fieldId);
      if (!field) {
        console.error(`Element with ID ${fieldId} not found.`);
        continue;
      }

      if (!field.value.trim()) {
        field.classList.add('error');
        if (isValid) {
          field.focus();
        }
        isValid = false;
      } else {
        field.classList.remove('error');
      }
    }

    const takeoutSelect = document.querySelector('input[name="takeoutType"]:checked');
    if (!takeoutSelect) {
      console.error('Takeout type not selected.');
      document.querySelectorAll('input[name="takeoutType"]').forEach(input => input.classList.add('error'));
      isValid = false;
    } else {
      document.querySelectorAll('input[name="takeoutType"]').forEach(input => input.classList.remove('error'));
    }

    return isValid;
  }


  window.addEventListener('load', function () {
    setTimeout(function () {
      const preloader = document.querySelector('.preloader');
      if (preloader) {
        preloader.classList.add('hidden');
      }
    }, 1000);
  });

  function validatePointsUsage() {
    const pointsInput = document.getElementById('points');
    const maxPoints = parseInt(pointsInput.getAttribute('max'), 10);
    let pointsValue = parseInt(pointsInput.value, 10) || 0;

    if (pointsValue > maxPoints) {
      pointsValue = maxPoints;
      pointsInput.value = maxPoints;
    }

    updateTotalPrice();
  }
</script>
</body>

</html>
