<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<body>
<div th:fragment="review">
  <div class="row">
    <div class="col-lg-4 col-12">
      <div class="single-block give-review">
        <h4>4.5 (전체)</h4>
        <ul>
          <li>
            <span>5 별 - 38</span>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
          </li>
          <li>
            <span>4 별 - 10</span>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star"></i>
          </li>
          <li>
            <span>3 별 - 3</span>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star"></i>
            <i class="lni lni-star"></i>
          </li>
          <li>
            <span>2 별 - 1</span>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star"></i>
            <i class="lni lni-star"></i>
            <i class="lni lni-star"></i>
          </li>
          <li>
            <span>1 별 - 0</span>
            <i class="lni lni-star-filled"></i>
            <i class="lni lni-star"></i>
            <i class="lni lni-star"></i>
            <i class="lni lni-star"></i>
            <i class="lni lni-star"></i>
          </li>
        </ul>
        <!-- Button trigger modal -->
        <button type="button" class="btn review-btn" data-bs-toggle="modal" data-bs-target="#exampleModal" th:if="${userInfo != null}">
          리뷰 작성하기
        </button>
        <button type="button" class="btn review-btn" th:if="${userInfo == null}" onclick="alert('로그인을 먼저 해주세요.')">
          리뷰 작성하기
        </button>
      </div>
    </div>
    <div class="col-lg-8 col-12">
      <div class="single-block">
        <div class="reviews">
          <h4 class="title">최근 리뷰</h4>
          <!-- Start Single Review -->
          <div class="single-review">
            <img src="https://via.placeholder.com/150x150" alt="#">
            <div class="review-info">
              <h4>가격 대비 훌륭한 품질
                <span>제이콥 해먼드</span>
              </h4>
              <ul class="stars">
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
              </ul>
              <p>로렘 입숨 돌로르 시트 아메트, 콘섹테투르 아디피시싱 엘리트...</p>
            </div>
          </div>
          <!-- End Single Review -->
          <!-- Start Single Review -->
          <div class="single-review">
            <img src="https://via.placeholder.com/150x150" alt="#">
            <div class="review-info">
              <h4>남편이 새...
                <span>알렉스 자자</span>
              </h4>
              <ul class="stars">
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star"></i></li>
              </ul>
              <p>로렘 입숨 돌로르 시트 아메트, 콘섹테투르 아디피시싱 엘리트...</p>
            </div>
          </div>
          <!-- End Single Review -->
          <!-- Start Single Review -->
          <div class="single-review">
            <img src="https://via.placeholder.com/150x150" alt="#">
            <div class="review-info">
              <h4>내가 좋아하는 품질...
                <span>제이콥 해먼드</span>
              </h4>
              <ul class="stars">
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
                <li><i class="lni lni-star-filled"></i></li>
              </ul>
              <p>로렘 입숨 돌로르 시트 아메트, 콘섹테투르 아디피시싱 엘리트...</p>
            </div>
          </div>
          <!-- End Single Review -->
        </div>
      </div>
    </div>
  </div>
  <!-- Review Modal -->
  <div class="modal fade review-modal" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">리뷰 남기기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="bookId" th:value="${book.bookId()}">
          <div class="row">
            <div class="col-sm-6">
              <div class="form-group">
                <label for="review-name">이름</label>
                <input class="form-control" type="text" id="review-name" th:value="${userInfo != null ? userInfo.name : ''}" th:disabled="${userInfo == null}" readonly>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-6">
              <div class="form-group">
                <label for="review-subject">제목</label>
                <input class="form-control" type="text" id="review-subject">
              </div>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                <label for="review-rating">평점</label>
                <select class="form-control" id="review-rating">
                  <option>5</option>
                  <option>4</option>
                  <option>3</option>
                  <option>2</option>
                  <option>1</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="review-message">리뷰 내용</label>
            <textarea class="form-control" id="review-message" rows="8" required></textarea>
          </div>
          <div class="form-group">
            <label for="review-images">사진 업로드</label>
            <input type="file" class="form-control" id="review-images" multiple accept="image/*" onchange="previewImages()">
          </div>
          <div class="form-group" id="preview-container"></div>
        </div>
        <div class="modal-footer button">
          <button type="button" class="btn" th:if="${userInfo != null}" onclick="submitReview()">리뷰 제출</button>
          <button type="button" class="btn" th:if="${userInfo == null}" onclick="alert('로그인을 먼저 해주세요.')">리뷰 제출</button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Review Modal -->

  <script>
    function checkLoginStatus() {
      const userInfo = /*[[${userInfo}]]*/ null;
      if (!userInfo) {
        alert('로그인을 먼저 해주세요.');
      }
    }

    function submitReview() {
      const reviewName = document.getElementById('review-name').value;
      const reviewSubject = document.getElementById('review-subject').value;
      const reviewRating = document.getElementById('review-rating').value;
      const reviewMessage = document.getElementById('review-message').value;
      const reviewImages = document.getElementById('review-images').files;
      const bookId = document.getElementById('bookId').value;

      if (!reviewName || !reviewSubject || !reviewRating || !reviewMessage) {
        alert('모든 필드를 작성해주세요.');
        return;
      }

      const formData = new FormData();
      formData.append('review', new Blob([JSON.stringify({
        name: reviewName,
        subject: reviewSubject,
        rating: reviewRating,
        message: reviewMessage,
        bookId: bookId
      })], { type: 'application/json' }));

      for (let i = 0; i < reviewImages.length; i++) {
        formData.append('images', reviewImages[i]);
      }

      fetch('/reviews', {
        method: 'POST',
        body: formData,
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('리뷰 작성에 실패했습니다.');
        }

        alert('리뷰가 성공적으로 작성하였습니다.');
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('리뷰 작성에 실패했습니다.');
      });
    }

    function previewImages() {
      const previewContainer = document.getElementById('preview-container');
      previewContainer.innerHTML = '';

      const files = document.getElementById('review-images').files;

      Array.from(files).forEach(file => {
        const reader = new FileReader();

        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.maxWidth = '100px';
          img.style.margin = '10px';
          previewContainer.appendChild(img);
        };

        reader.readAsDataURL(file);
      });
    }
  </script>
</div>
</body>
</html>
